<!DOCTYPE html><html data-bs-theme="light" lang="de"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no"><title>RegineWinkelmann</title><link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic&amp;display=swap"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Cabin:700&amp;display=swap"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Smythe&amp;display=swap"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="assets/css/styles.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"></head><body><nav class="navbar navbar-expand-xl fixed-top pb-4 pb-sm-4 pb-md-3 pb-lg-3 pb-xl-3 pb-xxl-3" id="mainNav"><div class="container"><img src="assets/img/DachsSymbolEffects.png" width="52" height="50"><a class="navbar-brand d-none d-sm-inline-block d-md-inline-block" href="#">Regine Winkelmann</a><button data-bs-toggle="collapse" class="navbar-toggler" data-bs-target="#navbarResponsive" type="button" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation" value="Menu"><i class="fa fa-bars"></i></button><div class="collapse navbar-collapse" id="navbarResponsive"><ul class="navbar-nav ms-auto"><li class="nav-item nav-link"><a class="nav-link" href="index.html#header" data-bs-target="index.html#header">Startseite</a></li><li class="nav-item nav-link"><a class="nav-link" href="index.html#about">Über die Autorin</a></li><li class="nav-item nav-link"><a class="nav-link" href="index.html#product">Der Dachs und die Welt</a></li><li class="nav-item nav-link"><a class="nav-link" href="index.html#blog">Blog</a></li><li class="nav-item nav-link"><a class="nav-link" href="#contact">contact</a></li><li class="nav-item nav-link"><div id="vue-cart-badge" class="nav-link-wrapper" style="visibility: hidden;">
  <a class="nav-link" href="cart.html">
    <span class="d-inline-block d-sm-inline-block d-md-inline-block d-lg-inline-block d-xl-none">Warenkorb</span>
    <i class="fa fa-shopping-basket"></i>
    <span v-if="cartItemCount > 0" class="badge price-badge text-bg-primary text-white">{{ cartItemCount }}</span>
  </a>
</div>

<script type="text/javascript">
(() => {
  function onReady(fn){
    if (document.readyState === "complete" || document.readyState === "interactive") setTimeout(fn,0);
    else document.addEventListener("DOMContentLoaded", fn, { once: true });
  }
  function whenShopAndVue(cb){
    if (window.Shop && window.Vue && window.Vue.createApp) cb();
    else setTimeout(() => whenShopAndVue(cb), 20);
  }

  onReady(() => whenShopAndVue(() => {
    const { createApp } = window.Vue;

    createApp({
      data(){ 
        return { 
          cartItemCount: 0 
        }; 
      },
      methods:{
        updateCount(){
          this.cartItemCount = Shop.cartCount();
        }
      },
      mounted(){
        this.updateCount();
        // Vue ist ready - Element sichtbar machen
        this.$el.style.visibility = 'visible';
        // Live-Updates: reagiert auf Shop.add / sonstige Änderungen
        Shop.onCartChange(() => this.updateCount());
      }
    }).mount('#vue-cart-badge');
  }));
})();
</script></li></ul></div></div></nav><header class="masthead shorthead" style="background: url(&quot;assets/img/gallery/pumpkinpicture.jpg&quot;) bottom / cover;height: 50vh;"><div class="intro-body"><div class="container"><div class="row"><div class="col-lg-8 mx-auto"><h1 class="brand-heading">Kasse</h1></div></div></div></div></header><section class="text-center py-5 content-section" id="checkout"><div class="container-xl"><div class="row"><div class="mx-auto" data-aos="slide-up"><div id="vue-checkout-app" class="stripe-checkout-container torn" style="visibility: hidden;">
  <!-- Loading Spinner -->
  <div v-if="isLoading" class="d-flex flex-column align-items-center justify-content-center" style="height: 520px;">
    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
    <div class="text-muted">
      <div class="fw-semibold mb-1">{{ loadingText }}</div>
      <small>Einen Moment bitte</small>
    </div>
  </div>
  
  <!-- Stripe Checkout Container -->
  <div v-show="!isLoading" id="stripe-checkout" style="min-height:520px;"></div>
  
  <!-- Error/Info Messages -->
  <div v-if="message" class="text-muted small mt-2" :class="{ 'text-danger': isError }">
    {{ message }}
  </div>
</div>

<script type="text/javascript">
(() => {
  // ---- Konfiguration ----
  const WORKER_ENDPOINT     = "https://reginewinkelmannstripe.vaax.workers.dev/create-checkout-session";
  const PUBLISHABLE_KEY_LIVE= "pk_live_xxxxxxxxxxxxxxxxxxxxx";
  const PUBLISHABLE_KEY_TEST= "pk_test_51RpPrnGSHI4ZzMNSYJ9oVy4H9y7YKVJ0Cr7bLmzvNQkAL9ZPPxDG9jycXSd41TyyLeNc09AKYJtXuFI3vyBDjZwV001ffxZKzp";

  // Success-/Cancel-URLs für Test & Live
  const SUCCESS_URL_TEST = "http://localhost:8000/success.html?session_id={CHECKOUT_SESSION_ID}";
  const CANCEL_URL_TEST  = "http://localhost:8000/cart.html";
  const SUCCESS_URL_LIVE = "https://reginewinkelmann.de/success.html?session_id={CHECKOUT_SESSION_ID}";
  const CANCEL_URL_LIVE  = "https://reginewinkelmann.de/cart.html";

  // Hilfsfunktion für Mode
  function cfg() {
    const isTest = (window.Shop && Shop.isTestMode());
    return {
      PUBLISHABLE_KEY: isTest ? PUBLISHABLE_KEY_TEST : PUBLISHABLE_KEY_LIVE,
      SUCCESS_URL:     isTest ? SUCCESS_URL_TEST     : SUCCESS_URL_LIVE,
      CANCEL_URL:      isTest ? CANCEL_URL_TEST     : CANCEL_URL_LIVE,
    };
  }

  // Warten bis DOM & dependencies verfügbar sind
  function onReady(fn){
    if (document.readyState === "complete" || document.readyState === "interactive") setTimeout(fn,0);
    else document.addEventListener("DOMContentLoaded", fn, { once:true });
  }
  function when(cond, cb){ cond() ? cb() : setTimeout(() => when(cond, cb), 20); }

  onReady(() => when(() => window.Stripe && window.Shop && window.Vue, initVueApp));

  function initVueApp() {
    const { createApp } = window.Vue;

    createApp({
      data() {
        return {
          isLoading: true,
          loadingText: "Checkout wird vorbereitet...",
          message: "",
          isError: false
        };
      },
      methods: {
        async initCheckout() {
          const { PUBLISHABLE_KEY, SUCCESS_URL, CANCEL_URL } = cfg();

          // Warenkorb prüfen
          const items = Shop.toCheckoutItems();
          if (!items.length) {
            this.showError("Warenkorb leer. Bitte zuerst Artikel hinzufügen.");
            return;
          }

          try {
            this.loadingText = "Checkout wird geladen...";

            // Session beim Worker anlegen
            const res = await fetch(WORKER_ENDPOINT, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                items,
                mode: "payment",
                success_url: SUCCESS_URL,
                cancel_url: CANCEL_URL,
                embed: true
              })
            });

            const data = await res.json();
            if (!res.ok) throw new Error(data?.error?.message || data?.error || "Session konnte nicht erstellt werden.");

            // Embedded Checkout
            if (data.client_secret) {
              this.loadingText = "Formular wird aufgebaut...";
              
              const stripe = Stripe(PUBLISHABLE_KEY);
              const checkout = await stripe.initEmbeddedCheckout({ clientSecret: data.client_secret });
              
              // Checkout mounten
              checkout.mount("#stripe-checkout");
              
              // Warten bis Stripe gerendert hat
              this.waitForStripeContent();
              return;
            }

            // Fallback: Redirect
            if (data.url) {
              window.location.href = data.url;
              return;
            }

            throw new Error("Unerwartete Antwort vom Server.");
          } catch (e) {
            console.error(e);
            this.showError("Fehler: " + (e?.message || e));
          }
        },

        waitForStripeContent() {
          const checkInterval = setInterval(() => {
            const checkoutEl = document.getElementById("stripe-checkout");
            if (checkoutEl && checkoutEl.children.length > 0) {
              this.isLoading = false;
              this.message = "";
              clearInterval(checkInterval);
            }
          }, 50);

          // Fallback: nach 5 Sekunden
          setTimeout(() => {
            this.isLoading = false;
            clearInterval(checkInterval);
          }, 5000);
        },

        showError(errorMsg) {
          this.isLoading = false;
          this.message = errorMsg;
          this.isError = true;
        }
      },
      mounted() {
        // Vue ist ready - Element sichtbar machen
        const appEl = document.getElementById('vue-checkout-app');
        if (appEl) {
          appEl.style.visibility = 'visible';
        }
        // Checkout initialisieren
        this.initCheckout();
      }
    }).mount('#vue-checkout-app');
  }
})();
</script>
</div></div></div></section><footer class="py-0"><div class="p-3 mb-2"><div class="container text-center"><div class="row"><div class="col-12 col-sm-12 col-md-5"><p class="my-2">2025 © Regine Winkelmann</p></div><div class="col-2 d-none d-sm-none d-md-block"><img src="assets/img/DachsSymbolEffects.png" width="58" height="56"></div><div class="col-12 col-sm-12 col-md-5"><ul class="list-inline my-2"><li class="list-inline-item"><a href="impressum.html">Impressum</a></li><li class="list-inline-item"><a href="agb.html">AGB</a></li><li class="list-inline-item"><a href="widerrufsbelehrung.html">Widerrufsbelehrung</a></li><li class="list-inline-item"><a href="versand.html">Versand</a></li></ul></div></div></div></div><div class="p-2" style="background: #1c1c1c;"><div class="container text-center"><div class="row"><div class="col"><div class="vaax-copyright" id="vaax-button" style="color:#fff;">
    <a href="https://va.ax/" style="color: #fff; text-decoration: none; font-family: Arial, Helvetica, sans-serif;">Webdesign realisiert durch die <i style="content: ''; width: 16px; height: 16px; position: relative; top: 2px; display: inline-block; background-position: center; background-repeat: no-repeat; background-size: contain; background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxODguMjc0IiBoZWlnaHQ9IjE5NC42MiIgdmlld0JveD0iMCAwIDE4OC4yNzQgMTk0LjYyIj4NCiAgPHBhdGggaWQ9IkxvZ29TaW5nbGVXaGl0ZSIgZD0iTTEzOC4yODYsMTguMDdsOTMuODY3LDE0OS42MDdMMjA0LjUxLDE4Mi4zOTFjLTIyLjAxNS0zNS4wNzUtNDMuOTQ0LTcwLTY2LjI0Mi0xMDUuNTIzTDg1LjUwNywxNjEuMDIybDI3LjkyNywxNC44N0wxMzguMywxMzYuMzQ0bDM4LjIyOSw2MC45LTI3LjYxNiwxNC43MTRjLTMuNDQ1LTUuNDMyLTYuODIxLTEwLjc1LTEwLjYxNy0xNi43MjhMMTI3LjQ4MiwyMTIuNjlsLTgzLjYtNDQuMTc3Qzc1LjM3LDExOC4zNDYsMTA2LjY2OCw2OC40NiwxMzguMjg2LDE4LjA3WiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTQzLjg4IC0xOC4wNykiIGZpbGw9IiNmZmYiLz4NCjwvc3ZnPg0K);"></i> <span class="vaax-title">VAAX Multimedia Agentur</span></a>
  </div></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script><script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script><script src="https://js.stripe.com/v3/"></script><script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script><script src="assets/js/script.min.js"></script></body></html>