<!DOCTYPE html>
<html data-bs-theme="light" lang="de">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>RegineWinkelmann</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/Cabin.css">
    <link rel="stylesheet" href="assets/css/Lora.css">
    <link rel="stylesheet" href="assets/css/Smythe.css">
    <link rel="stylesheet" href="assets/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/bss-overrides.css">
    <link rel="stylesheet" href="assets/css/aos.min.css">
    <link rel="stylesheet" href="assets/css/blog-slider.compiled.css">
    <link rel="stylesheet" href="assets/css/Footer-Clean-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
    <link rel="stylesheet" href="assets/css/Lightbox-Gallery-baguetteBox.min.css">
    <link rel="stylesheet" href="assets/css/style.compiled.css">
</head>

<body>
    <nav class="navbar navbar-expand-xl fixed-top pb-4 pb-sm-4 pb-md-3 pb-lg-3 pb-xl-3 pb-xxl-3" id="mainNav">
        <div class="container"><a href="index.html#"><img src="assets/img/DachsSymbolEffects.png" width="52" height="50"></a><a class="navbar-brand d-none d-sm-inline-block d-md-inline-block" href="index.html#">Regine Winkelmann</a><button data-bs-toggle="collapse" class="navbar-toggler" data-bs-target="#navbarResponsive" type="button" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation" value="Menu"><i class="fa fa-bars"></i></button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item nav-link"><a class="nav-link" href="index.html#header" data-bs-target="index.html#header">Startseite</a></li>
                    <li class="nav-item nav-link"><a class="nav-link" href="index.html#about">√úber die Autorin</a></li>
                    <li class="nav-item nav-link"><a class="nav-link" href="index.html#product">Der Dachs und die Welt</a></li>
                    <li class="nav-item nav-link"><a class="nav-link" href="#contact">Kontakt</a></li>
                    <li class="nav-item nav-link"><div id="vue-cart-badge" class="nav-link-wrapper" style="visibility: hidden;">
  <a class="nav-link" href="cart.html">
    <span class="d-inline-block d-sm-inline-block d-md-inline-block d-lg-inline-block d-xl-none">Warenkorb</span>
    <i class="fa fa-shopping-basket"></i>
    <span v-if="cartItemCount > 0" class="badge price-badge text-bg-primary text-white">{{ cartItemCount }}</span>
  </a>
</div>

<script type="text/javascript">
(() => {
  function onReady(fn){
    if (document.readyState === "complete" || document.readyState === "interactive") setTimeout(fn,0);
    else document.addEventListener("DOMContentLoaded", fn, { once: true });
  }
  function whenShopAndVue(cb){
    if (window.Shop && window.Vue && window.Vue.createApp) cb();
    else setTimeout(() => whenShopAndVue(cb), 20);
  }

  onReady(() => whenShopAndVue(() => {
    const { createApp } = window.Vue;

    createApp({
      data(){ 
        return { 
          cartItemCount: 0 
        }; 
      },
      methods:{
        updateCount(){
          this.cartItemCount = Shop.cartCount();
        }
      },
      mounted(){
        this.updateCount();
        // Vue ist ready - Element sichtbar machen
        this.$el.style.visibility = 'visible';
        // Live-Updates: reagiert auf Shop.add / sonstige √Ñnderungen
        Shop.onCartChange(() => this.updateCount());
      }
    }).mount('#vue-cart-badge');
  }));
})();
</script></li>
                </ul>
            </div>
        </div>
    </nav>
    <header class="masthead shorthead" style="background: linear-gradient(rgba(0,0,0,0.62) 0%, rgba(0,0,0,0) 22%), url(&quot;assets/img/DachsbuchPromo_004.webp&quot;) center center / cover;height: 50vh;background-size: auto, cover;">
        <div class="intro-body">
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <h1 class="brand-heading">Kasse</h1>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <section class="text-center py-5 content-section" id="checkout">
        <div class="container-xl">
            <div class="row">
                <div class="mx-auto" data-aos="slide-up"><div id="vue-checkout-app" class="stripe-checkout-container torn" style="visibility: hidden;">
  <!-- Loading Spinner -->
  <div v-if="isLoading" class="d-flex flex-column align-items-center justify-content-center" style="height: 520px;">
    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
    <div class="text-muted">
      <div class="fw-semibold mb-1">{{ loadingText }}</div>
      <small>Einen Moment bitte</small>
    </div>
  </div>
  
  <!-- Stripe Checkout Container -->
  <div v-show="!isLoading" id="stripe-checkout" style="min-height:520px;"></div>
  
  <!-- Error/Info Messages -->
  <div v-if="message" class="text-muted small mt-2" :class="{ 'text-danger': isError }">
    {{ message }}
  </div>
</div>

<script type="text/javascript">
(() => {
  // ---- Konfiguration ----
  // Worker-Endpoint wird aus Shop.js geholt - KEINE Fallbacks!
  function getWorkerEndpoint() {
    if (!window.Shop || typeof window.Shop.getWorkerEndpoint !== 'function') {
      throw new Error('Shop.js ist nicht verf√ºgbar! Checkout kann nicht initialisiert werden.');
    }
    return window.Shop.getWorkerEndpoint() + '/create-checkout-session';
  }
  
  const PUBLISHABLE_KEY_LIVE= "pk_live_51RpPrnGSHI4ZzMNSGvJOHVdy2fukEYUN54rY83R0bFZZhdkYV91Nr068Tvc8tPdxSRp7BoXTlRTtKU3sCPbMbQhS00r9r83zzl";
  const PUBLISHABLE_KEY_TEST= "pk_test_51RpPrnGSHI4ZzMNSYJ9oVy4H9y7YKVJ0Cr7bLmzvNQkAL9ZPPxDG9jycXSd41TyyLeNc09AKYJtXuFI3vyBDjZwV001ffxZKzp";

  // URLs werden von shop.js basierend auf Umgebung bereitgestellt
  function getUrls() {
    if (!window.Shop || typeof window.Shop.isTestMode !== 'function') {
      throw new Error('Shop.js ist nicht verf√ºgbar! URL-Konfiguration kann nicht geladen werden.');
    }
    
    const baseUrl = `${window.location.protocol}//${window.location.host}`;
    const isTest = window.Shop.isTestMode();
    
    if (isTest) {
      return {
        SUCCESS_URL: `${baseUrl}/success.html?session_id={CHECKOUT_SESSION_ID}`,
        CANCEL_URL: `${baseUrl}/cart.html`,
        ERROR_URL: `${baseUrl}/error.html?session_id={CHECKOUT_SESSION_ID}`
      };
    } else {
      return {
        SUCCESS_URL: "https://reginewinkelmann.de/success.html?session_id={CHECKOUT_SESSION_ID}",
        CANCEL_URL: "https://reginewinkelmann.de/cart.html", 
        ERROR_URL: "https://reginewinkelmann.de/error.html?session_id={CHECKOUT_SESSION_ID}"
      };
    }
  }

  // Hilfsfunktion f√ºr Mode - erwartet funktionierende shop.js!
  function cfg() {
    if (!window.Shop || typeof window.Shop.isTestMode !== 'function') {
      throw new Error('Shop.js ist nicht verf√ºgbar! Modus kann nicht ermittelt werden.');
    }
    
    const isTest = window.Shop.isTestMode();
    const urls = getUrls();
    
    console.log('üîç Checkout-Modus:', isTest ? 'TEST' : 'LIVE', 'f√ºr', window.location.hostname);
    
    return {
      PUBLISHABLE_KEY: isTest ? PUBLISHABLE_KEY_TEST : PUBLISHABLE_KEY_LIVE,
      SUCCESS_URL: urls.SUCCESS_URL,
      CANCEL_URL: urls.CANCEL_URL,
      ERROR_URL: urls.ERROR_URL,
    };
  }

  // Warten bis DOM & dependencies verf√ºgbar sind
  function onReady(fn){
    if (document.readyState === "complete" || document.readyState === "interactive") setTimeout(fn,0);
    else document.addEventListener("DOMContentLoaded", fn, { once:true });
  }
  function when(cond, cb){ cond() ? cb() : setTimeout(() => when(cond, cb), 20); }

  onReady(() => when(() => window.Stripe && window.Shop && window.Vue, initVueApp));

  function initVueApp() {
    const { createApp } = window.Vue;

    createApp({
      data() {
        return {
          isLoading: true,
          loadingText: "Checkout wird vorbereitet...",
          message: "",
          isError: false
        };
      },
      methods: {
        async initCheckout() {
          // Shop.js Verf√ºgbarkeit pr√ºfen
          if (!window.Shop) {
            this.handleCriticalError('Shop.js ist nicht geladen! Bitte Seite neu laden.', null);
            return;
          }

          let sessionId = null;

          try {
            const { PUBLISHABLE_KEY, SUCCESS_URL, CANCEL_URL } = cfg();

            // Warenkorb pr√ºfen
            const items = window.Shop.toCheckoutItems();
            if (!items.length) {
              this.showError("Warenkorb leer. Bitte zuerst Artikel hinzuf√ºgen.");
              return;
            }
            this.loadingText = "Checkout wird geladen...";

            // Worker-Endpoint dynamisch ermitteln
            const workerEndpoint = getWorkerEndpoint();
            console.log('üöÄ Verwende Worker-Endpoint:', workerEndpoint);

            // Session beim Worker anlegen
            const res = await fetch(workerEndpoint, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                items,
                mode: "payment",
                success_url: SUCCESS_URL,
                cancel_url: CANCEL_URL,
                embed: true
              })
            });

            const data = await res.json();
            
            // Session-ID extrahieren falls vorhanden
            if (data.id) {
              sessionId = data.id;
            }

            if (!res.ok) {
              const errorMsg = data?.error?.message || data?.error || "Session konnte nicht erstellt werden.";
              
              // Bei kritischen Server-Fehlern zur Error-Seite weiterleiten
              if (res.status >= 500 || res.status === 400) {
                this.handleCriticalError(errorMsg, sessionId);
                return;
              }
              
              throw new Error(errorMsg);
            }

            // Embedded Checkout
            if (data.client_secret) {
              this.loadingText = "Formular wird aufgebaut...";
              
              try {
                const stripe = Stripe(PUBLISHABLE_KEY);
                const checkout = await stripe.initEmbeddedCheckout({ 
                  clientSecret: data.client_secret,
                  onComplete: () => {
                    // Optional: Erfolg-Handler
                    console.log('Checkout completed');
                  }
                });
                
                // Checkout mounten
                checkout.mount("#stripe-checkout");
                
                // Warten bis Stripe gerendert hat
                this.waitForStripeContent(sessionId);
                return;
              } catch (stripeError) {
                console.error('Stripe initialization failed:', stripeError);
                this.handleCriticalError('Stripe konnte nicht geladen werden', sessionId);
                return;
              }
            }

            // Fallback: Redirect
            if (data.url) {
              window.location.href = data.url;
              return;
            }

            throw new Error("Unerwartete Antwort vom Server.");
          } catch (e) {
            console.error('Checkout initialization error:', e);
            
            // Bei Netzwerk-/Server-Fehlern zur Error-Seite
            if (e.name === 'TypeError' && e.message.includes('fetch')) {
              this.handleCriticalError('Verbindung zum Server fehlgeschlagen', sessionId);
            } else {
              // Andere Fehler zun√§chst inline anzeigen
              this.showError("Fehler: " + (e?.message || e));
              
              // Nach 5 Sekunden trotzdem zur Error-Seite wenn Fehler persistent
              setTimeout(() => {
                if (this.isError) {
                  this.redirectToError(sessionId);
                }
              }, 5000);
            }
          }
        },

        waitForStripeContent(sessionId = null) {
          let attempts = 0;
          const maxAttempts = 100; // 5 Sekunden bei 50ms Intervall
          
          const checkInterval = setInterval(() => {
            attempts++;
            const checkoutEl = document.getElementById("stripe-checkout");
            
            if (checkoutEl && checkoutEl.children.length > 0) {
              this.isLoading = false;
              this.message = "";
              clearInterval(checkInterval);
              return;
            }
            
            // Nach zu vielen Versuchen Fehler anzeigen
            if (attempts >= maxAttempts) {
              clearInterval(checkInterval);
              console.error('Stripe content failed to load after 5 seconds');
              this.handleCriticalError('Stripe Formular konnte nicht geladen werden', sessionId);
            }
          }, 50);
        },

        showError(errorMsg) {
          this.isLoading = false;
          this.message = errorMsg;
          this.isError = true;
        },

        // Weiterleitung zur Error-Seite mit Session-ID
        redirectToError(sessionId = null) {
          const { ERROR_URL } = cfg();
          let errorUrl = ERROR_URL;
          
          if (sessionId) {
            errorUrl = errorUrl.replace('{CHECKOUT_SESSION_ID}', sessionId);
          } else {
            // Fallback ohne Session-ID
            errorUrl = errorUrl.replace('?session_id={CHECKOUT_SESSION_ID}', '');
          }
          
          console.log('Redirecting to error page:', errorUrl);
          window.location.href = errorUrl;
        },

        // Kritische Fehler mit sofortiger Weiterleitung
        handleCriticalError(error, sessionId = null) {
          console.error('Critical checkout error:', error);
          
          // Kurz Fehlermeldung anzeigen, dann weiterleiten
          this.showError('Fehler beim Checkout. Sie werden weitergeleitet...');
          
          setTimeout(() => {
            this.redirectToError(sessionId);
          }, 2000); // 2 Sekunden warten
        }
      },
      mounted() {
        // Vue ist ready - Element sichtbar machen
        const appEl = document.getElementById('vue-checkout-app');
        if (appEl) {
          appEl.style.visibility = 'visible';
        }
        // Checkout initialisieren
        this.initCheckout();
      }
    }).mount('#vue-checkout-app');
  }
})();
</script>
</div>
            </div>
        </div>
    </section>
    <footer class="py-0">
        <div class="p-3 mb-2">
            <div class="container text-center">
                <div class="row">
                    <div class="col-12 col-sm-12 col-md-5">
                        <p class="my-2">2025 ¬© Regine Winkelmann</p>
                    </div>
                    <div class="col-2 d-none d-sm-none d-md-block"><img src="assets/img/DachsSymbolEffects.png" width="58" height="56"></div>
                    <div class="col-12 col-sm-12 col-md-5">
                        <ul class="list-inline my-2">
                            <li class="list-inline-item"><a href="impressum.html">Impressum</a></li>
                            <li class="list-inline-item"><a href="agb.html">AGB</a></li>
                            <li class="list-inline-item"><a href="widerrufsbelehrung.html">Widerrufsbelehrung</a></li>
                            <li class="list-inline-item"><a href="versand.html">Versand</a></li>
                            <li class="list-inline-item"><a href="datenschutz.html">Datenschutzerkl√§rung</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-2" style="background: #1c1c1c;">
            <div class="container text-center">
                <div class="row">
                    <div class="col"><div class="vaax-copyright" id="vaax-button" style="color:#fff;">
    <a href="https://va.ax/" style="color: #fff; text-decoration: none; font-family: Arial, Helvetica, sans-serif;">Webdesign realisiert durch die <i style="content: ''; width: 16px; height: 16px; position: relative; top: 2px; display: inline-block; background-position: center; background-repeat: no-repeat; background-size: contain; background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxODguMjc0IiBoZWlnaHQ9IjE5NC42MiIgdmlld0JveD0iMCAwIDE4OC4yNzQgMTk0LjYyIj4NCiAgPHBhdGggaWQ9IkxvZ29TaW5nbGVXaGl0ZSIgZD0iTTEzOC4yODYsMTguMDdsOTMuODY3LDE0OS42MDdMMjA0LjUxLDE4Mi4zOTFjLTIyLjAxNS0zNS4wNzUtNDMuOTQ0LTcwLTY2LjI0Mi0xMDUuNTIzTDg1LjUwNywxNjEuMDIybDI3LjkyNywxNC44N0wxMzguMywxMzYuMzQ0bDM4LjIyOSw2MC45LTI3LjYxNiwxNC43MTRjLTMuNDQ1LTUuNDMyLTYuODIxLTEwLjc1LTEwLjYxNy0xNi43MjhMMTI3LjQ4MiwyMTIuNjlsLTgzLjYtNDQuMTc3Qzc1LjM3LDExOC4zNDYsMTA2LjY2OCw2OC40NiwxMzguMjg2LDE4LjA3WiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTQzLjg4IC0xOC4wNykiIGZpbGw9IiNmZmYiLz4NCjwvc3ZnPg0K);"></i> <span class="vaax-title">VAAX Multimedia Agentur</span></a>
  </div></div>
                </div>
            </div>
        </div>
    </footer>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/aos.min.js"></script>
    <script src="assets/js/bs-init.js"></script>
    <script src="assets/js/grayscale.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="assets/js/Lightbox-Gallery-baguetteBox.min.js"></script>
    <script src="assets/js/Lightbox-Gallery.js"></script>
    <script src="assets/js/shop.js"></script>
</body>

</html>